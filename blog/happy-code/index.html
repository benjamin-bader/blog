<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Just Android stuff"><meta property="twitter:site" content="@pianoben"><meta property="og:site_name" content="bendb"><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="og:url" content="https://www.bendb.com/blog/happy-code/"><meta property="og:title" content="happy code"><meta property="twitter:title" content="happy code"><meta property="twitter:card" content="summary"><meta property="og:description" content><meta property="twitter:description" content><title>bendb - happy code</title><link rel=canonical href=https://www.bendb.com/blog/happy-code/><style media=screen>@font-face{font-family:nexa bold;src:url('https://www.bendb.com/fonts/Nexa Bold.otf')}html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,img,ins,kbd,q,s,samp,small,strike,strong,sub,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td,article,aside,canvas,details,embed,figure,figcaption,footer,header,hgroup,menu,nav,output,ruby,section,summary,time,mark,audio,video{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section,div.column{display:block}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}table{border-collapse:collapse;border-spacing:0}*,*:before,*:after{box-sizing:border-box}a,a:visited,a:focus,a:active{text-decoration:none}html{height:100%;font-size:16px}body{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:column;-moz-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;-webkit-justify-content:flex-start;-moz-justify-content:flex-start;-ms-justify-content:flex-start;justify-content:flex-start;width:100%;min-height:100%;font-weight:400;font-family:helvetica neue,arial,sans-serif;color:#111;line-height:1.6;text-rendering:optimizeLegibility!important}.icon{text-rendering:geometricPrecision!important}section{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;width:100%}div.column{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;width:100%}.container{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;width:100%}div.header .container{-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center}div.header .content{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:column;-moz-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center}div.header .container .logo{max-width:100px;margin-left:-2em;clip-path:circle()}div.header .name{padding-top:20px;font-size:28px;font-family:nexa bold,helvetica neue,arial,sans-serif;letter-spacing:-.005rem;text-transform:uppercase;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-smoothing:antialiased;color:#333}div.header nav{margin-bottom:16px}div.header nav ul{list-style:none;text-align:center;display:-webkit-inline-flex;display:-moz-inline-flex;display:-ms-inline-flexbox;display:-ms-inline-flex;display:inline-flex}div.header nav ul li{margin-left:6px;margin-right:6px}div.header nav ul li:first-child{margin-left:0}div.header nav ul li:last-child{margin-right:0}div.header nav ul a{color:#555;font-weight:400;font-size:14px;text-transform:uppercase;font-family:helvetica neue,arial,sans-serif;-webkit-transition:color .1s cubic-bezier(.47,0,.75,.72);-moz-transition:color .1s cubic-bezier(.47,0,.75,.72);-ms-transition:color .1s cubic-bezier(.47,0,.75,.72);-o-transition:color .1s cubic-bezier(.47,0,.75,.72)}div.header nav ul a:hover{color:#111}div.footer .container{-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center;flex-direction:column-reverse;width:100%;text-align:center}div.footer .container a{font-size:14px;margin-left:6px;margin-right:6px;opacity:.6;-webkit-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-moz-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-ms-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-o-transition:opacity .1s cubic-bezier(.47,0,.75,.72)}div.footer .container a:first-child{margin-left:0}div.footer .container a:last-child{margin-right:0}div.footer .container a:hover{opacity:.8}div.footer .container a .icon{width:16px;height:16px}div.footer .container .copyright{flex-grow:.5;text-align:start}div.footer .container .icons{flex-grow:.5;text-align:end}div.main .container{-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;-webkit-justify-content:flex-start;-moz-justify-content:flex-start;-ms-justify-content:flex-start;justify-content:flex-start}div.main .content{color:#111;font-size:16px}div.main .content .title-container{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-justify-content:space-between;-moz-justify-content:space-between;-ms-justify-content:space-between;justify-content:space-between}div.main .content .posts{}div.main .content .page-heading{font-size:20px;font-weight:700;font-family:helvetica neue,arial,sans-serif;letter-spacing:-.005rem;text-transform:uppercase;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-smoothing:antialiased;color:#333;margin-bottom:16px}div.main .content .front-matter .page-heading{margin-bottom:0}div.main .content .front-matter .meta{font-size:14px;color:#666;display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;margin-bottom:32px}div.main .content .front-matter .date,div.main .content .front-matter .author,div.main .content .front-matter .tags,div.main .content .front-matter .word-count,div.main .content .front-matter .middot:before{display:none}div.main .content .front-matter .middot:before{font-size:6px;margin:0 6px;vertical-align:middle;content:"â€¢"}div.main .content .front-matter .tags ul{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:row;-moz-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center}div.main .content .front-matter .tags ul li{-webkit-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-moz-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-ms-transition:opacity .1s cubic-bezier(.47,0,.75,.72);-o-transition:opacity .1s cubic-bezier(.47,0,.75,.72)}div.main .content .front-matter .tags ul li:hover{opacity:.7}div.main .content .front-matter .tags ul li a{color:#666}div.main .container.f04{-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center}div.main .container.f04 .content{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:column;-moz-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center}div.main .container.f04 .content .num{margin:30px 0 30px 0;font-weight:400;font-family:helvetica neue,arial,sans-serif;font-size:50px}div.main .container.f04 .content .detail{margin-bottom:40px}div.main .container .content .groupby{margin-top:1em;padding-left:.5em}div.main .container .content .post-item{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;display:list-item;list-style:disc inside}div.main .container .content .post-item .meta{font-size:14px;color:#666;display:none;min-width:100px}div.main .container .content .see-more{font-style:italic;float:right;font-size:.9em;margin-top:2em;color:#313537}div.main .container .content .see-more:hover{color:#666}section{padding:0 16px}div.column{padding:0 16px}div.header{padding-top:10px}div.header-home{padding-top:36px}div.main{padding-top:32px}div.main .container .content .post-item .meta{display:block}div.main .container .content .post-item{display:flex;list-style:none}a{color:#428bca;-webkit-transition:color .1s cubic-bezier(.47,0,.75,.72);-moz-transition:color .1s cubic-bezier(.47,0,.75,.72);-ms-transition:color .1s cubic-bezier(.47,0,.75,.72);-o-transition:color .1s cubic-bezier(.47,0,.75,.72)}a:hover{color:#2a6496}img{max-width:100%}div.main .content{width:100%}div.main .content .markdown{font-size:1.1em;line-height:1.75em;color:#313537;font-family:serif;font-weight:300}div.main .content .markdown h1,div.main .content .markdown h2,div.main .content .markdown h3,div.main .content .markdown h4,div.main .content .markdown h5,div.main .content .markdown h6{font-size:22px;font-family:helvetica neue,arial,sans-serif;letter-spacing:-.005rem;font-weight:700;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-smoothing:antialiased;color:#333;text-transform:none;margin-top:1.75rem}div.main .content .markdown h1{font-size:1.75rem;margin-bottom:2rem}div.main .content .markdown h2{font-size:1.5rem;margin-bottom:1.5rem}div.main .content .markdown h3{font-size:1em;margin-bottom:1rem}div.main .content .markdown h4,div.main .content .markdown h5,div.main .content .markdown h6{font-size:1rem;margin-bottom:1rem;letter-spacing:none}div.main .content .markdown code,div.main .content .markdown pre{font-family:menlo,monospace;font-size:.98rem;background-color:#f7f7f7}div.main .content .markdown code{padding:.15em .5em;border-radius:2px}div.main .content .markdown pre{display:block;margin-top:1rem;margin-bottom:2rem;padding:1rem;line-height:1.5em;white-space:pre;word-break:break-all;word-wrap:break-word}div.main .content .markdown pre code{padding:0;font-size:.9rem}div.main .content .markdown a code{color:#428bca!important}div.main .content .markdown a code:hover{text-decoration:underline}div.main .content .markdown p{text-align:justify;margin-top:0;margin-bottom:1em}div.main .content .markdown ul,div.main .content .markdown ol,div.main .content .markdown dl{margin-top:1rem;margin-bottom:2rem}div.main .content .markdown dt{font-weight:700}div.main .content .markdown dd{margin-bottom:.5rem}div.main .content .markdown ul{list-style-type:disc;list-style-position:outside;margin-bottom:1.25rem}div.main .content .markdown ol{list-style-type:decimal;margin-bottom:1.25rem}div.main .content .markdown li{margin-left:2em}div.main .content .markdown em{font-style:italic}div.main .content .markdown strong{font-weight:700}div.main .content .markdown hr{position:relative;margin:1.75rem 0;border:0;border-top:1px solid gray;border-top:1px solid #999}div.main .content .markdown abbr{font-size:.85rem;font-weight:700;color:#666;text-transform:uppercase}div.main .content .markdown abbr[title]{cursor:help;border-bottom:1px dotted gray}div.main .content .markdown blockquote{padding:.5rem 1rem;margin:.8rem 0;color:#7a7a7a;border-left:.25rem solid #e5e5e5}div.main .content .markdown blockquote p:last-child{margin-bottom:0}div.main .content .markdown figure{width:100%;background:#fff;margin-bottom:1em}div.main .content .markdown figure img{width:100%;height:auto;max-width:100%;display:block;position:static;margin:auto}div.main .content .markdown table{margin-bottom:1rem;width:100%;border:1px solid #e5e5e5;border-collapse:collapse}div.main .content .markdown td,div.main .content .markdown th{padding:.25rem .5rem;border:1px solid #e5e5e5}div.main .content .markdown tbody tr:nth-child(odd) td,div.main .content .markdown tbody tr:nth-child(odd) th{background-color:#f7f7f7}div.main .content .markdown .footnotes ol{list-style-type:decimal;margin-left:16px}div.main .content .markdown .footnotes li{list-style-type:unset}div.main .content .markdown .footnote-ref{font-size:.7em}div.main .content .navigation{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:column;-moz-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;padding:2em}div.main .content .navigation div{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:row;-moz-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;margin-top:1em}div.main .content .navigation .icon{width:16px;height:16px}div.main .content .navigation a{width:250px;margin:0 1em;text-align:center;font-style:italic;color:#313537}div.main .content .share,div.main .content .share div{display:-webkit-flex;display:-moz-flex;display:-ms-flexbox;display:-ms-flex;display:flex;-webkit-flex-direction:row;-moz-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-align-items:center;-moz-align-items:center;-ms-align-items:center;align-items:center;justify-content:center}div.main .content .share{background-color:rgba(152,152,152,7%);padding:1em 0}div.main .content .share a{margin:0 6px}kbd{padding:.1em .6em;border:1px solid #ccc;font-size:11px;font-family:Arial,Helvetica,sans-serif;background-color:#f7f7f7;color:#333;-moz-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 2px #ffffff inset;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 2px #ffffff inset;box-shadow:0 1px rgba(0,0,0,.2),0 0 0 2px #ffffff inset;-moz-border-radius:3px;-webkit-border-radius:3px;border-radius:3px;display:inline-block;margin:0 .1em;text-shadow:0 1px 0 #fff;line-height:1.4;white-space:nowrap}body,div.header nav ul a,div.main .content .page-heading,div.main .container.f04 .content .num,div.main .content .markdown h1,div.main .content .markdown h2,div.main .content .markdown h3,div.main .content .markdown h4,div.main .content .markdown h5,div.main .content .markdown h6{font-family:raleway}div.main .content .markdown{font-family:merriweather}div.main .content .markdown code,div.main .content .markdown pre{font-family:ubuntu mono}</style><style media="(min-width: 600px)">body{-webkit-justify-content:center;-moz-justify-content:center;-ms-justify-content:center;justify-content:center}.non-narrow.zero-top-spacing{padding-top:0!important}section{padding:0 16px;margin-left:100px;margin-right:100px;max-width:750px}div.column{padding:0 16px;max-width:750px}div.header{background-color:transparent}div.header .container{-webkit-justify-content:flex-start;-moz-justify-content:flex-start;-ms-justify-content:flex-start;justify-content:flex-start}div.header .container .logo{margin:0}div.header-home .container .logo{max-width:216px;margin-left:24px}div.header-home .name-home{padding-top:30px;font-size:40px}div.header-home nav ul a{font-size:18px}div.header .content{-webkit-align-items:flex-start;-moz-align-items:flex-start;-ms-align-items:flex-start;align-items:flex-start}div.header .name{color:#333}div.header nav{font-size:14px;margin-bottom:0}div.header nav ul{text-align:left}div.header nav ul a{color:#666}div.header nav ul a:hover{color:#333}div.footer{background-color:transparent}div.footer .container{flex-direction:row}div.footer .container a{margin-left:3px;margin-right:3px;color:#666}div.footer .container a:hover{color:#333}div.footer .container a .icon{font-size:18px}div.footer .container a .icon.larger{font-size:20px}div.main .content .front-matter .date,div.main .content .front-matter .author,div.main .content .front-matter .tags,div.main .content .front-matter .word-count,div.main .content .front-matter .middot:before{display:initial}div.main .container.f04{-webkit-justify-content:flex-start;-moz-justify-content:flex-start;-ms-justify-content:flex-start;justify-content:flex-start}div.main .container.f04 .content{-webkit-align-items:flex-start;-moz-align-items:flex-start;-ms-align-items:flex-start;align-items:flex-start}div.main .container.f04 .content .num{margin:0 0 10px;font-size:32px}div.main .container.f04 .content .detail{margin-bottom:30px}.container{padding:0 30px}div.header{padding-top:60px;padding-bottom:60px}div.footer{padding-top:60px;padding-bottom:60px}div.main{padding-top:0}div.main .content{font-size:16px}div.main .container .content .post-item{display:flex;list-style:none;padding-left:1.5em}div.main .container .content .post-item .meta{display:block}div.main .content .markdown blockquote{padding-right:5rem;padding-left:1.25rem}div.main .content .navigation{-webkit-flex-direction:row;-moz-flex-direction:row;-ms-flex-direction:row;flex-direction:row}div.main .content .navigation div{margin-top:0}</style><style media="(min-width: 769px)">div.main .content .markdown figure{width:110%;margin-left:-4%}div.main .content .markdown img{max-width:110%;width:110%;margin-left:-4%}div.main .content .markdown pre{width:110%;margin-left:-4%}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;600;700&family=Merriweather:ital,wght@0,300;0,700;1,300;1,700&family=Ubuntu+Mono:wght@400;700&display=block" rel=stylesheet><link rel="shortcut icon" href=https://www.bendb.com/img/favicon.ico></head><body><div class="header column"><div class=container><a href=https://www.bendb.com/><img class=logo src=https://www.bendb.com/img/profile.jpg alt=logo></a><div class=content><a href=https://www.bendb.com/><div class=name><h1>bendb</h1></div></a><nav><ul><li><a href=https://www.bendb.com/blog/>Blog</a></li><li><a href=https://www.bendb.com/code/>code</a></li><li><a href=https://www.bendb.com/about/>About</a></li></ul></nav></div></div></div><div class="main post non-narrow zero-top-spacing column"><div class=container><div class=content><div class=front-matter><div class=title-container><div class=page-heading>happy code</div></div><div class=meta><div class=date title="Wed Apr 6 2016 21:42:04 PST">Apr 6, 2016</div><div class="reading-time middot">4 minute read</div><div class=tags><ul><li class=middot><a href=https://www.bendb.com/tags/java>java</a></li><li class=middot><a href=https://www.bendb.com/tags/code>code</a></li><li class=middot><a href=https://www.bendb.com/tags/design>design</a></li></ul></div><div class=tags><ul></ul></div></div></div><div class=markdown><p>My favorite parts of being a programmer are those moments when, after ruminating on a bit of not-quite-clean code, elegant solutions just present themselves to you. Today&rsquo;s installment is from <a href=https://github.com/Microsoft/thrifty>Thrifty</a>, the Thrift implementation for Android I wrote at Microsoft.</p><p>Briefly, part of Thrifty&rsquo;s job is to generate Java classes corresponding to structs defined in Thrift IDL. Part of that is generating descriptive <code>.toString()</code> methods. For the first release, Thrifty generated code like this:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>public</span> String toString() {
</span></span><span style=display:flex><span>  StringBuilder sb = <span style=font-weight:700>new</span> StringBuilder(<span style=font-style:italic>&#34;Foo{&#34;</span>);
</span></span><span style=display:flex><span>  sb.append(<span style=font-style:italic>&#34;bar=&#34;</span>);
</span></span><span style=display:flex><span>  sb.append(<span style=font-weight:700>this</span>.bar);
</span></span><span style=display:flex><span>  sb.append(<span style=font-style:italic>&#34;, &#34;</span>);
</span></span><span style=display:flex><span>  sb.append(<span style=font-style:italic>&#34;baz=&#34;</span>);
</span></span><span style=display:flex><span>  sb.append(<span style=font-weight:700>this</span>.baz);
</span></span><span style=display:flex><span>  sb.append(<span style=font-style:italic>&#34;}&#34;</span>);
</span></span><span style=display:flex><span>  <span style=font-weight:700>return</span> sb.toString();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Not terrible, for generated code, but nothing to write home about. In particular, it lacks in readability and efficiency - it doesn&rsquo;t resemble code you or I would write by hand, and some of those literals strings could be combined to reduce the number of method calls here. IntelliJ correctly calls out code like this as in need of replacement.</p><p>If you or I were to write this by hand, it would look something like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>public</span> String toString() {
</span></span><span style=display:flex><span>  <span style=font-weight:700>return</span> <span style=font-style:italic>&#34;Foo{bar=&#34;</span> + <span style=font-weight:700>this</span>.bar + <span style=font-style:italic>&#34;, baz=&#34;</span> + <span style=font-weight:700>this</span>.baz + <span style=font-style:italic>&#34;}&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I should point out that this is far from the most pressing issue - nobody realistically depends on <code>toString()</code> for anything perf-sensitive. The only reason to improve this code is personal satisfaction - and a recent cross-country plane ride provided the perfect opportunity.</p><p>Before the fix, the code to generate <code>toString()</code> was relatively easy to follow, once you know the idioms of Square&rsquo;s JavaPoet codegen library. Here&rsquo;s the (only slightly) simplified original version, which is hacky and very much rushed out the door by me</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-style:italic>// The actual code is hairier, handling some extra things
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>MethodSpec.Builder toString = MethodSpec.methodBuilder(<span style=font-style:italic>&#34;toString&#34;</span>)
</span></span><span style=display:flex><span>    .addAnnotation(Override.class)
</span></span><span style=display:flex><span>    .addModifiers(Modifier.PUBLIC)
</span></span><span style=display:flex><span>    .returns(String.class);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic>// Two things going on here:
</span></span></span><span style=display:flex><span><span style=font-style:italic>// 1. Adding a single statement to the method
</span></span></span><span style=display:flex><span><span style=font-style:italic>// 2. Statements can take format specifiers - here, $S means &#34;a quoted literal string&#34;,
</span></span></span><span style=display:flex><span><span style=font-style:italic>//    properly escaped.
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>toString.addStatement(<span style=font-style:italic>&#34;StringBuilder sb = new StringBuilder($S)&#34;</span>, struct.name() + <span style=font-style:italic>&#34;{&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span>int</span> index = 0;  <span style=font-style:italic>// what even was I thinking lol
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span style=font-weight:700>for</span> (Field f : struct.fields()) {
</span></span><span style=display:flex><span>  <span>boolean</span> isLast = ++index == struct.fields().size();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  toString.addStatement(<span style=font-style:italic>&#34;sb.append($S)&#34;</span>, field.name() + <span style=font-style:italic>&#34;=&#34;</span>);
</span></span><span style=display:flex><span>  <span style=font-weight:700>if</span> (field.redacted()) {
</span></span><span style=display:flex><span>    toString.addStatement(<span style=font-style:italic>&#34;sb.append($S)&#34;</span>, <span style=font-style:italic>&#34;&lt;REDACTED&gt;&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=font-weight:700>else</span> {
</span></span><span style=display:flex><span>    toString.addStatement(<span style=font-style:italic>&#34;sb.append(this.$N)&#34;</span>, field.name()); <span style=font-style:italic>// &#34;$N&#34; as a format means &#34;Java name&#34;
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700>if</span> (isLast) {
</span></span><span style=display:flex><span>    toString.addStatement(<span style=font-style:italic>&#34;sb.append(\&#34;}\&#34;)&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=font-weight:700>else</span> {
</span></span><span style=display:flex><span>    toString.addStatement(<span style=font-style:italic>&#34;sb.append(\&#34;, \&#34;)&#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>toString.addStatement(<span style=font-style:italic>&#34;return sb.toString()&#34;</span>);
</span></span></code></pre></div><p>OK! Pretty simple, right? Except for that <code>index</code> bit, it&rsquo;s not so bad. Easy to read, relatively speaking. It&rsquo;s easy because generating this kind of code is uncomplicated. The better example, the one without <code>StringBuilder</code>, takes a good deal more consideration. Around 20,000 feet into the air, I started to think. What needs to change here? Obviously, we need to detect when two &ldquo;compile-time-constant&rdquo; strings are adjacent, like the example above of the <code>", "</code> followed by <code>"baz="</code>. How do we track that? We could keep the same structure, but just add pieces of strings together:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>return</span> <span style=font-style:italic>&#34;Foo{&#34;</span> + <span style=font-style:italic>&#34;bar=&#34;</span> + <span style=font-weight:700>this</span>.bar + <span style=font-style:italic>&#34;, &#34;</span> + <span style=font-style:italic>&#34;baz=&#34;</span> + <span style=font-weight:700>this</span>.baz + <span style=font-style:italic>&#34;}&#34;</span>;
</span></span></code></pre></div><p>An improvement! This is significantly more readable, and just about every compiler out there will optimize out the constant concatenations. The fact is, though, it still looks kind of goofy, and with this reduced character count the extra contatenations are quite a bit of noise obscuring the actual signal.</p><p>Turns out, the solution that I hit on is to introduce a new class (hey, it&rsquo;s Java) to represent a chunk of code, which can be either a literal string or a reference to a field. You can build a list of these chunks in one pass through the field list, and then emit each chunk of code in order. Splitting the generation into two passes removes the need for hard-to-reason-about flags, and lets us focus on doing this more-complicated process correctly:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=font-weight:700>class</span> <span style=font-weight:700>Chunk</span> {
</span></span><span style=display:flex><span>  <span style=font-weight:700>final</span> String formatSpecifier;
</span></span><span style=display:flex><span>  <span style=font-weight:700>final</span> String value;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  Chunk(<span>boolean</span> isString, String value) {
</span></span><span style=display:flex><span>    <span style=font-weight:700>this</span>.formatSpecifier = isString ? <span style=font-style:italic>&#34;$S&#34;</span> : <span style=font-style:italic>&#34;$L&#34;</span>;
</span></span><span style=display:flex><span>    <span style=font-weight:700>this</span>.value = value;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>List&lt;Chunk&gt; chunks = <span style=font-weight:700>new</span> ArrayList&lt;&gt;();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>StringBuilder sb = <span style=font-weight:700>new</span> StringBuilder();
</span></span><span style=display:flex><span><span>boolean</span> appendedOneField = <span style=font-weight:700>false</span>; <span style=font-style:italic>// no more index
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span style=font-weight:700>for</span> (Field field : struct.fields()) {
</span></span><span style=display:flex><span>  <span style=font-weight:700>if</span> (appendedOneField) {
</span></span><span style=display:flex><span>    sb.append(<span style=font-style:italic>&#34;, &#34;</span>);
</span></span><span style=display:flex><span>  } <span style=font-weight:700>else</span> {
</span></span><span style=display:flex><span>    appendedOneField = <span style=font-weight:700>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=font-weight:700>if</span> (field.redacted()) {
</span></span><span style=display:flex><span>    sb.append(<span style=font-style:italic>&#34;&lt;REDACTED&gt;&#34;</span>);
</span></span><span style=display:flex><span>  } <span style=font-weight:700>else</span> {
</span></span><span style=display:flex><span>    chunks.add(<span style=font-weight:700>new</span> Chunk(<span style=font-weight:700>true</span>, sb.toString()));
</span></span><span style=display:flex><span>    chunks.add(<span style=font-weight:700>new</span> Chunk(<span style=font-weight:700>false</span>, <span style=font-style:italic>&#34;this.&#34;</span> + field.name))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sb.setLength(0);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sb.append(<span style=font-style:italic>&#34;}&#34;</span>);
</span></span><span style=display:flex><span>chunks.add(<span style=font-weight:700>new</span> Chunk(<span style=font-weight:700>true</span>, sb.toString()));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic>// Now, we can actually generate code!
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span>boolean</span> firstChunk = <span style=font-weight:700>true</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic>// MethodSpec.Builder lets us work with whole statements at once;
</span></span></span><span style=display:flex><span><span style=font-style:italic>// we want finer-grained control over the emitted Java right now.
</span></span></span><span style=display:flex><span><span style=font-style:italic>// CodeBlock.Builder is an in-progress Java snippet.
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>CodeBlock.Builder block = CodeBlock.builder();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700>for</span> (Chunk chunk : chunks) {
</span></span><span style=display:flex><span>  <span style=font-weight:700>if</span> (firstChunk) {
</span></span><span style=display:flex><span>    block.add(<span style=font-style:italic>&#34;$[&#34;</span>);  <span style=font-style:italic>// Start-of-statement
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>    block.add(<span style=font-style:italic>&#34;return &#34;</span>);
</span></span><span style=display:flex><span>  } <span style=font-weight:700>else</span> {
</span></span><span style=display:flex><span>    block.add(<span style=font-style:italic>&#34; + &#34;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  block.add(chunk.formatSpecifier, chunk.value);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>block.add(<span style=font-style:italic>&#34;;$]\n&#34;</span>); <span style=font-style:italic>// end-of-statement gibberish
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>toString.addCode(block.build());
</span></span></code></pre></div><p>&mldr;and, that&rsquo;s it! The method is significantly longer now, but it remains readable - and best of all, we acheived what we set out to accomplish! <code>.toString()</code> methods that look the way we want them to. This is pretty</p></div></div></div></div><div class="footer column"><div class=container><div class=copyright></div><div class=icons><a href=https://github.com/benjamin-bader rel=me target=_blank><img class=icon src=https://www.bendb.com/img/github.svg alt=github></a>
<a href=https://twitter.com/pianoben rel=me target=_blank><img class=icon src=https://www.bendb.com/img/twitter.svg alt=twitter></a>
<a href=https://www.linkedin.com/in/bendb rel=me target=_blank><img class=icon src=https://www.bendb.com/img/linkedin.svg alt=linkedin></a>
<a href=mailto:ben@bendb.com><img class=icon src=https://www.bendb.com/img/email.svg alt=email></a>
<a rel=me href=https://androiddev.social/@ben><img class=icon src=https://www.bendb.com/img/mastodon.svg alt=mastodon></a></div></div></div><script>window.onload=function(){}</script></body></html>